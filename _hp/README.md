# HTTP Header Security
- Run statistic:
- Run 1:
  - All have 1706 finish messages (the printed exception error in del does not matter? only ugly?)
  - Firefox H: 853 X: 853
    - 0 crashes?
    - however 180x Timeout while closing (driver.quit()) the browser, 90x headless, 90x headfull; there has to be a systematic issue?
    - Maybe there exist some fixed responses with which it is possible to "kill" Firefox? Make it unresponsive
  - Edge H: 853 X: 853
    - 91/853  crashes (all headfull, (session not created: DevToolsActivePort file doesn't exist))
  - Chrome H: 853 X: 853
    - 153/853 crashes (all headfull, (session not created: DevToolsActivePort file doesn't exist))
  - Brave H: 853 X: 853
    - 239/853 crashes (all headfull, (session not created: DevToolsActivePort file doesn't exist))
  - Run 2:
    - Firefox:
      - Headfull: 450/853 start crashes: `Process unexpectedly closed with status 1`; Timeout while closing 45
      - Headless: Timeouts while closing 89
    - Edge:
      - Headfull: 162/853 start crashes `(session not created: DevToolsActivePort file doesn't exist)`, one crash in between: `Message: disconnected: received Inspector.detached event\n  (Session info: MicrosoftEdge=119.0.2151.97)`
      - Headless: one crash in between: `HTTPConnectionPool(host='localhost', port=60117): Max retries exceeded with url: /session/f9bbefafb2210657aa26247075c49d24/window`
    - Chrome:
      - Headfull: 368/853 `(session not created: DevToolsActivePort file doesn't exist)` start crashes 
      - Headless: /
    - Brave:
      - Headfull: 339/853 `(session not created: DevToolsActivePort file doesn't exist)` start crashes
      - Headless: /
- Run 3:
  - Firefox: 0/853 crashes?! 90/853 + 90/853 Timeout while closing!
  - Edge: 130/853 crashes (headfull, all DevTools)
  - Chrome: 177/853 crashes (headfull, all DevTools)
  - Brave: 283/853 (headfull, 282 DevTools, 1 "'NoneType' object has no attribute 'get'")
- Run 4 and following:
  - Firefox still many timeouts (180/Run)
  - No crashed for Brave, Firefox, Chrome
  - Rare crashes (even for headless) for Edge (e.g., 4/803 in the second run, 10/803 in the first run): 
    - "[Errno 26] Text file busy: '/home/ubuntu/.cache/selenium/msedgedriver/linux64/121.0.2277.98/msedgedriver'"
    - "Message: unknown error: cannot find msedge binary"
    - "(session not created: DevToolsActivePort file doesn't exist)"
    - "'NoneType' object has no attribute 'get'"
    - "Message: timeout: Timed out receiving message from renderer: 14.000"
    - "Message: invalid session id"
    - "Message: unknown error: no msedge binary at /home/ubuntu/.cache/selenium/MicrosoftEdge/linux64/121.0.2277.98/"
    - Should not matter too much as we will repeat all tests that do not have a result until we have results for all tests

- Elastic PW="uxCLpajVSN4tnseNIZ1U"
- Kibana token="eyJ2ZXIiOiI4LjEyLjAiLCJhZHIiOlsiMTAuMjUzLjE2Ny4xNTk6OTIwMCJdLCJmZ3IiOiI5MjQ0ZDlmYzk4MDlhMDIyZWJjNjhkOWU2NDZmMWJkMmQzOTBhOGIwYzA5YWFiOWU3YWYxNzJhMTZiYTBmOTUwIiwia2V5IjoiaGNTelZZMEJMY1NGaXFRMkk1WE86Sm5sbm5takRRcXl6aW4zQ1lxSWVEQSJ9"


- Setup:
    - Create a fresh Ubuntu22 container/VM: `lxc launch ubuntu:22.04 <name>` and connect to it `lxc exec <name> bash`
    - Switch to the ubuntu user: `su - ubuntu`
    - Clone this repository: `git clone git@projects.cispa.saarland:swag/wpt.git`
    - Run the setup file: `cd wpt/_hp`, `./setup.bash` (reopen all terminals or run `source ~/.bashrc` afterwards)
    - Configure DB settings in [config.json](config.json)
    - Setup the database: `cd _hp/tools && poetry run python models.py`
    - Setup certs: either remove `.demo` from the files in `_hp/tools/certs/` to use self-signed certs or add the real certs there
- Run:
    - Start the WPT Server (from the top-most folder): `poetry run -C _hp python wpt serve --config _hp/wpt-config.json`
    - Automatic: Start the testrunners, e.g., `poetry run desktop_selenium.py`
    - Manual: Visit http://sub.headers.websec.saarland:80/_hp/tests/framing.sub.html (HTTPS: 443)
- TODOs:
    - create useful responses for each feature group
    - analyse results!
      - discover differences in browsers/versions
      - "explain" reasons (keep in mind that other features such as blocked mixed content and CORB might be responsible for differences and not different parsing of the security header)
    - ...
- Inventory (of _hp):
    - wpt-config.json: Ports, Domains, Certs, ... (Subdomains currently hardcoded in tools/serve/serve.py)
    - common/: Shared non-js files for the tests (images, html, ...)
    - resources/: Shared javascript files for the tests (testharness, save_results, ...)
    - server/
        - responses.py: Serves the correct responses from the db (responses.py?resp_id=<int>&feature_group=<str>)
        - store_results.py: Stores the test results in the db (expects JSON with {tests: [...], browser=browser_id})
    - tests/
        - One file for each feature group to test
        - Create one testcase for everything one wants to test
        - Then run these for all corresponding responses and relevant origin configurations
        - How to provide parameters to the tests
            - http://sub.headers.websec.saarland:80/_hp/tests/framing.sub.html?browser=<browser_id>&first_id=<id>&last_id=<id>
    - tools/
        - Non web files
        - config.json: DB connection and co.
        - crawler/ The code for the crawlers that visit the tests
        - models.py: Defines the database models (results, responses, ...); creates dummy data if run directly
        - create_responses.py: create two responses for each feature group: "deny" and "allow" for testing the tests
- The only other relevant files are:
    - tools/serve/...: Config to run WPT
    - tools/wptserve/...: The WPT server
    - Some of the tests to take inspirations e.g., x-frame-options/...