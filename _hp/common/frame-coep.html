<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <script>
        var urlParams = new URLSearchParams(decodeURIComponent(window.location.search));
        var id = urlParams.get("count");
        let url = urlParams.get("origin") + '/_hp/server/responses.py?feature_group=coep&resp_id=';
        let origin = urlParams.get("origin");
        let nest = urlParams.get("nest");
        let response_id = urlParams.get("resp_id");
        let element = urlParams.get("element");
        if (nest == 1) {
            let loadedCount = 0;
            let result = {};
            const onImageLoad = (event, image) => {
                loadedCount++;
                result[image] = event;
                if (loadedCount === 4) {
                    // All images have loaded
                    const sortedKeys = Object.keys(result).sort();
                    const sortedObject = {};

                    sortedKeys.forEach(key => {
                    sortedObject[key] = result[key];
                    });
                    window.parent.postMessage({ "id": id, "message": { "window.crossOriginIsolated": window.crossOriginIsolated, "image-events": sortedObject } }, "*");
                }
            };
            for (let image of ["swag.jpg", "swag-cross-site.jpg", "swag-same-site.jpg", "swag-same-origin.jpg"]) {
                let i = document.createElement(element);
                i.src = origin + "/_hp/common/" + image;
                i.onload = () => onImageLoad("load", image);
                i.onerror = () => onImageLoad("error", image);
                document.body.appendChild(i);
            }
        } else {
            window.addEventListener("message", (e) => {
                window.parent.postMessage(e.data, "*");
            });
            const i = document.createElement('iframe');
            const final_url = url + response_id + `&count=${id}&nest=${nest - 1}&origin=${origin}&element=${element}&resp=1`;
            i.src = final_url;
            document.body.append(i);
        }
    </script>
</body>

</html>