{# templates/results.html #}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{title}}</title>
  <script src="/static/testharness.js"></script>
  <script src="/static/testharnessreport.js"></script>

</head>

<body>

</body>

<script> 
	const queryString = window.location.search;
	const urlParams = new URLSearchParams(decodeURIComponent(queryString));
	async function save_result(tests, status) {
		var test_results = tests.map(function(x) {
			return {name: x.name, outcome: x.outcome, status: x.status, message: x.message, stack: x.stack}
		});
		var data = {
					// Results for the individual tests + metainfo (which browser)
					tests: test_results,
					browser: urlParams.get('browser'),
					// Currently unused other metadata (status etc. of the complete test file run)
					test: window.location.href,
					status: status.status,
					message: status.message,
					stack: status.stack,
				};
		await fetch('http://{{SAME_ORIGIN}}/store_result', {
			method: 'POST',
			body: JSON.stringify(data),
			mode: 'no-cors',
			headers: {
				'Content-Type': 'application/json',
			}
		});
	}
	add_completion_callback(save_result);
	//await save_result({ 'uid': entryId, 'result': 'valid', 'test': 'xfo' }, 'http://{{SAME_ORIGIN}}/store_result', urlParams.get('browser'));

</script>

<script>
{% block test_declarations %}{% endblock %}
</script>

<script>
for (var test of test_declarations) {
	const url = document.location.origin + '/runtest?test=xfo&pair=';
	const suburl = `http://{{SUB_SAME_ORIGIN}}/runtest?test=xfo&pair=`;
	const randomurl = `http://{{CROSS_ORIGIN}}/runtest?test=xfo&pair=`;
	// TODO: decide which responses to run on, ...
	var response = 1;
	for (var u of [url, suburl, randomurl]) {
		test({url: u, response: response, message: `XFO-${u}-${response}`});
	}
}



</script>

</script>
</html>