<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch CORS Tests</title>
    <script src="/_hp/resources/testharness.js"></script>
    <script src="/_hp/resources/store_results.sub.js"></script>
</head>

<body>

</body>


<script>
    var count = 0;
    function access_fetch_test(method, credentials, headers, test_info, url, origin, response_id) {
        /*
        url: str, URL to be tested (next in the framing chain)
        origin: str, Origin of the URL to be tested
        response_id: int, ID of the response element (final response of the chain)
        method: str, GET, TEST
        credentials: str, "omit", "include"
        headers: Headers
        test_info: str, additional information about the test (direct, sandbox, nested (A->B->A->A))
        */
        test_name = `fetch_${method}|${credentials}|${headers.get("Test")}|${test_info}|${origin}|${response_id}`;
        //console.log(url, response_id, test_name);
        async_test(t => {
            t.set_test_info(url, test_info);
            let final_url = url + response_id + `&resp=1`;
            fetch(final_url, { "mode": "cors", "method": method, "credentials": credentials, "headers": headers }).then((r) => test_fetch(t, r, null)).catch((e) => test_fetch(t, null, e))
            // Cleanup function (not called for tests that time out?)
            t.add_cleanup(() => { });
        }, test_name);
    }

    function test_fetch(t, response, error) {
        let headersString = '';
        if (response) {
            response.headers.forEach((value, name) => {
                headersString += `${name},`;
            });
        }
        t.report_outcome({ "headers": headersString, "error": format_value(error) });
        t.done();
    }

    // A -> B (sets AC-XX), original A: access B (headers and co.)
    const simple_fetch = access_fetch_test.bind(null, 'GET', "omit", new Headers(), "simple");
    const custom_method = access_fetch_test.bind(null, "TEST", "omit", new Headers(), "custom_method");
    const custom_headers = access_fetch_test.bind(null, "GET", "omit", new Headers({ "Test": "Test" }), "custom_headers")
    const credentials_fetch = access_fetch_test.bind(null, "GET", "include", new Headers(), "credendials")
    // Other tests? caching, ..

    const test_declarations = [simple_fetch, custom_method, custom_headers, credentials_fetch];
    const path = '/_hp/server/responses.py?feature_group=cors&resp_id=';
    const label = 'CORS';
    run_tests(test_declarations, path, label);

</script>

</html>