{% extends "base.html" %}

{% block test_declarations %}
// TODO: better put in an a js file and load it into the template rather then extending the base?
function simple_framing(testcase, url) {
    const ifr = document.createElement('iframe');
    ifr.src = url + testcase;
    ifr.style = "display: none";
    document.body.appendChild(ifr);
}

//var test_declarations = [simple_framing];

function xfo_test({ url, response, message }) {
    console.log(url, response, message);
    async_test(t => {
      const i = document.createElement("iframe");
      i.src = url + response;
  
      //waitForMessageFrom(i, t).then(t.unreached_func("Frame should not have sent a message."));
      i.onload = t.step_func_done(() => {
        //assert_equals(i.contentDocument, null);
        t.report_outcome({"frames.length": i.contentWindow.frames.length});
        assert_equals(null, null);

      });
      //waitForMessageFrom(i, t).then(t.step_func_done(e => {
      //  assert_equals(e.data, "Loaded");
      //}));
  
      document.body.append(i);
      t.add_cleanup(() => i.remove());
    }, message);
  }
  
  function waitForMessageFrom(frame, test) {
    return new Promise(resolve => {
      window.addEventListener("message", test.step_func(e => {
        console.log(e);
        if (e.source == frame.contentWindow) {
          resolve(e);
        }
      }));
    });
  }
  
  var test_declarations = [xfo_test];

{% endblock %}