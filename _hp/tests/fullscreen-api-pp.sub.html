<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PP Fullscreen Tests</title>
  <script src="/_hp/resources/testharness.js"></script>
  <script src="/_hp/resources/store_results.sub.js"></script>
</head>

<body>

</body>


<script>
  let urlParams = new URLSearchParams(decodeURIComponent(window.location.search));
  let resp_type = urlParams.get("resp_type") || "debug";
  var count = 0;
  function access_fullscreen_test(element, sandbox, test_info, url, origin, response_id) {
    /*
    url: str, URL to be tested (next in the framing chain)
    origin: str, Origin of the URL to be tested
    response_id: int, ID of the response element (final response of the chain)
    element: str, iframe/object/embed
    sandbox: bool whether to add the sandbox attribute to the next frame
    test_info: str, additional information about the test (direct, sandbox, nested (A->B->A->A))
    */
    test_name = `fullscreen_${element}|${sandbox}|${test_info}|${origin}|${response_id}`;
    //console.log(url, response_id, test_name);
    async_test(t => {
      t.set_test_info(url, test_info);
      const i = document.createElement(element);
      count = count + 1;
      i.id = count;
      let origin = location.origin;
      let resp = 1;
      let nest;
      if (test_info == "direct") {
        nest = 0;
      } else {
        nest = 1;
      }
      let final_url = url + response_id + `&count=${i.id}&nest=${nest}&origin=${origin}&element=${element}&resp=${resp}&test_info=${test_info}`
      i.data = final_url; // Object
      i.src = final_url; // Embed + IFrame
      i.allow = "fullscreen *";
      i.allowfullscreen = true;
      // Wait for 90% of test_timeout; then report that no message was received!
      let timer = t.step_timeout(() => {
        t.report_outcome("message timeout");
        t.done();
      }, 0.9 * test_timeout);
      // Report that a message was received
      waitForMessageFrom(i, t).then(t.step_func_done(e => {
        clearTimeout(timer);
        t.report_outcome(e.data.message);
      }));
      // Cleanup function (remove the frame after the test)
      t.add_cleanup(() => i.remove());
      // Start the test
      document.body.append(i);
    }, test_name);
  }

  // The FP/PP configured response header is only set on B (allow * on initial A, not on other As)
  // A -> B (allow): access API
  const simple_access = access_fullscreen_test.bind(null, 'iframe', false, "direct");
  // A -> B (allow) -> A (nothing): access API
  const child_access = access_fullscreen_test.bind(null, 'iframe', false, "child");
  // A -> B (allow) -> A (allow): access API
  const child_allow_access = access_fullscreen_test.bind(null, 'iframe', false, "child_allow");
  // A -> B (allow) -> A (sandbox): access API
  const child_sandbox_access = access_fullscreen_test.bind(null, 'iframe', false, "child_sandbox");

  // Notes:
  // Fullscreen: not supported on iPhone (https://caniuse.com/mdn-api_document_fullscreenenabled)? 
  // Alternative: query geolocation navigator.permissions.query({"name": "geolocation"}).then(r => r.state)
  // Results can be granted, prompt, or denied; if header disallows it should be denied otherwise prompt -> problem: FF + WebKit seem to always show prompt!
  // Support for everything permission related seems to be quite low currently: https://wpt.fyi/results/?label=master&label=experimental&aligned&q=permissions
  // Other alternative: try to access geolocation or something similar directly (problem, how to handle permissions prompts?)
  // navigator.geolocation.getCurrentPosition(successCallback, console.error, { maximumAge: 600_000 });
  let test_declarations;
  if (resp_type === "parsing") {
    test_declarations = [simple_access, child_allow_access];
  } else {
    test_declarations = [simple_access, child_access, child_allow_access, child_sandbox_access];
  }
  const path = '/_hp/server/responses.py?feature_group=pp&resp_id=';
  const label = 'PP';
  run_tests(test_declarations, path, label);

</script>

</html>