<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OriginAgentCluster Tests</title>
    <script src="/_hp/resources/testharness.js"></script>
    <script src="/_hp/resources/store_results.sub.js"></script>
</head>

<body>

</body>


<script>
    let urlParams = new URLSearchParams(decodeURIComponent(window.location.search));
    let resp_type = urlParams.get("resp_type") || "debug";
    var count = 0;
    function access_oac_test(element, sandbox, test_info, url, origin, response_id) {
        /*
        url: str, URL to be tested (next in the framing chain)
        origin: str, Origin of the URL to be tested
        response_id: int, ID of the response element (final response of the chain)
        element: str, iframe/object/embed
        sandbox: bool whether to add the sandbox attribute to the next frame
        test_info: str, additional information about the test (direct, sandbox, nested (A->B->A->A))
        */
        test_name = `oac_${element}|${sandbox}|${test_info}|${origin}|${response_id}`;
        //console.log(url, response_id, test_name);
        async_test(t => {
            t.set_test_info(url, test_info);
            const i = document.createElement(element);
            count = count + 1;
            i.id = count;
            let origin = location.origin;
            let resp = 1;
            let nest = 0;
            if (sandbox) {
                i.sandbox = "allow-scripts";
            }
            let final_url = url + response_id + `&count=${i.id}&nest=${nest}&origin=${origin}&element=${test_info}&resp=${resp}`
            let w;
            if (test_info == "window.open") {
                w = window.open(final_url, "_blank");
            } else {
                i.src = final_url;
            }

            // Wait for 90% of test_timeout; then report that no message was received!
            let timer = t.step_timeout(() => {
                t.report_outcome("message timeout");
                t.done();
            }, 0.9 * test_timeout);
            // Report that a message was received
            waitForMessageFrom(i, t).then(t.step_func_done(e => {
                clearTimeout(timer);
                t.report_outcome(e.data.message);
            }));
            // Cleanup function (remove the frame after the test)
            t.add_cleanup(() => {
                if (test_info == "window.open") {
                    w.close();
                }
                i.remove();
            });
            // Start the test
            document.body.append(i);
        }, test_name);
    }

    // A -> B: access API
    const simple_access = access_oac_test.bind(null, 'iframe', false, "direct");
    // A -> B (sandbox): access API
    const sandbox_access = access_oac_test.bind(null, 'iframe', true, "sandbox");
    // Depends on the OAC (and scheme) of the embedding document as well? -> thus better to test with window.open
    const window_access = access_oac_test.bind(null, 'window.open', false, "window.open")


    // Notes:
    // Only supported in Chromium at the moment (2023-10)
    // Potential "caching" issue: The page requested an origin-keyed agent cluster using the Origin-Agent-Cluster header, but could not be origin-keyed since the origin 'https://sub.headers.websec.saarland' had previously been placed in a site-keyed agent cluster. Update your headers to uniformly request origin-keying for all pages on the origin.
    // Also has effects on setting document.domain: https://html.spec.whatwg.org/multipage/browsers.html#relaxing-the-same-origin-restriction
    let test_declarations;
    if (resp_type === "parsing") {
        test_declarations = [window_access];
    } else {
        test_declarations = [simple_access, sandbox_access, window_access];
    }
    const path = '/_hp/server/responses.py?feature_group=oac&resp_id=';
    const label = 'OAC';
    run_tests(test_declarations, path, label);

</script>

</html>