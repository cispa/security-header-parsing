<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subresource Loading (CORP) Tests</title>
  <script src="/_hp/resources/testharness.js"></script>
  <script src="/_hp/resources/store_results.sub.js"></script>
</head>

<body>

</body>


<script>
  let urlParams = new URLSearchParams(decodeURIComponent(window.location.search));
  let resp_type = urlParams.get("resp_type") || "debug";
  var count = 0;
  function subresource_loading_test(element, sandbox, test_info, url, origin, response_id) {
    /*
    url: str, URL to be tested (next in the framing chain)
    origin: str, Origin of the URL to be tested
    response_id: int, ID of the response element (final response of the chain)
    element: str, iframe/object/embed
    sandbox: bool whether to add the sandbox attribute to the next frame
    test_info: str, additional information about the test (direct, sandbox, nested (A->B->A->A))
    */
    test_name = `subresourceloadingCORP_${element}|${sandbox}|${test_info}|${origin}|${response_id}`;
    //console.log(url, response_id, test_name);
    if (test_info == "direct") {
      async_test(t => {
        t.set_test_info(url, test_info);
        const i = document.createElement(element)
        i.onload = () => {
          t.report_outcome("load");
          t.done();
        }
        i.onerror = () => {
          t.report_outcome("error");
          t.done();
        }
        let final_url = url + response_id + `&nest=0&resp=1`
        i.src = final_url;
        i.data = final_url;
        t.add_cleanup(() => i.remove());
        document.body.appendChild(i);
      }, test_name);
    } else {
      nested_test('iframe', sandbox, url, response_id, element, test_info, test_name);
    }
  }


  // A -> B
  const simple_subresource_loading = subresource_loading_test.bind(null, "img", false, "direct");
  // CORP should not apply to object, however it does in Firefox (https://bugzilla.mozilla.org/show_bug.cgi?id=1732106)
  const object_subresource_loading = subresource_loading_test.bind(null, "object", false, "direct");
  // CORP should only take the parent into account?
  // A -> B (sandbox) -> A
  const sandboxed_subresource_loading = subresource_loading_test.bind(null, "img", true, "sandbox");
  // A -> B -> A -> A
  const nested_subresource_loading = subresource_loading_test.bind(null, "img", false, "nested");

  // TODO: add other more advanced tests?
  // Other elements (script, fetch (no-cors and others?, CORP should only be active for no-cors), ...)
  // Data URL?
  // (General note: more complex tests are not too important as we want to test the parsing of different header values and not edge case behavior for well-specified header values.
  // Edge cases for well-specified headers are mostly tested in WPT e.g.,: https://wpt.fyi/results/fetch/cross-origin-resource-policy?label=master&label=experimental&aligned&q=cross-origin-resource)
  // Relationship with COEP? (test in COEP tests!)  // ...
  let test_declarations;
  if (resp_type === "parsing") {
    test_declarations = [simple_subresource_loading];
  } else {
    test_declarations = [simple_subresource_loading, object_subresource_loading, sandboxed_subresource_loading, nested_subresource_loading];
  }
  const path = '/_hp/server/responses.py?feature_group=corp&resp_id=';
  const label = 'CORP';
  run_tests(test_declarations, path, label);

</script>

</html>