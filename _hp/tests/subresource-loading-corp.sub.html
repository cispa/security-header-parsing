<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subresource Loading (CORP) Tests</title>
  <script src="/_hp/resources/testharness.js"></script>
  <!-- <script src="/_hp/resources/testharnessreport.js"></script> -->
  <script src="/_hp/resources/store_results.sub.js"></script>
</head>

<body>

</body>


<script>
var count = 0;
function subresource_loading_test(element, sandbox, test_info, url, origin, response_id) {
  /*
  url: str, URL to be tested (next in the framing chain)
  origin: str, Origin of the URL to be tested
  response_id: int, ID of the response element (final response of the chain)
  element: str, iframe/object/embed
  sandbox: bool whether to add the sandbox attribute to the next frame
  test_info: str, additional information about the test (direct, sandbox, nested (A->B->A->A))
  */
    test_name =  `subresourceloading_${element}|${sandbox}|${test_info}|${origin}|${response_id}`;
    //console.log(url, response_id, test_name);
    async_test(t => {
      t.set_test_info(url, test_info);

      if (test_info == "direct") {
        const i = document.createElement(element)
        i.onload = () => {
            t.report_outcome("load");
            t.done();
        }
        i.onerror = () => {
            t.report_outcome("error");
            t.done();
        }
        i.src = url + response_id + `&nest=0`;
        i.data = url + response_id + `&nest=0`;
        //t.add_cleanup(() => i.remove());
        document.body.appendChild(i);
      }
      // TODO: WIP check that nested tests are working correctly?
      else {
        const i = document.createElement('iframe');
        count = count + 1;
        i.id = count;
        let origin = location.origin;
        let nesting = 0;
        if (sandbox) {
          i.sandbox = "allow-scripts";
          nesting = 1;
        }
        // A -> B -> A -> A embedding
        if (test_info === "nested") {
          nesting = 2;
        }
        let final_url = url + response_id + `&count=${i.id}&nest=${nesting}&origin=${origin}&element=${element}`
        i.data = final_url; // Object
        i.src = final_url; // Embed + IFrame
    
        // Wait for 90% of test_timeout; then report that no message was received!
        let timer = t.step_timeout(() => {
          t.report_outcome("message timeout");
          t.done();
        }, 0.9 * test_timeout);
  
        // Report that a message was received
        waitForMessageFrom(i, t).then(t.step_func_done(e => {
          clearTimeout(timer);
          t.report_outcome(e.data.message);
        }));
        // Cleanup function (remove the frame after the test)
        //t.add_cleanup(() => i.remove());
        // Start the test
        document.body.append(i);
      }

    }, test_name);
  }
  
  
  // A -> B
  const simple_subresource_loading = subresource_loading_test.bind(null, "img", false, "direct");
  // CORP should not apply to object, however it does in Firefox (https://bugzilla.mozilla.org/show_bug.cgi?id=1732106)
  const object_subresource_loading = subresource_loading_test.bind(null, "object", false, "direct");
  // A -> B (sandbox) -> A
  const sandboxed_subresource_loading = subresource_loading_test.bind(null, "img", true, "sandbox");
  // A -> B -> A -> A
  const nested_subresource_loading = subresource_loading_test.bind(null, "img", false, "nested");

  // TODO: add other more advanced tests?
  // Other elements (script, fetch (no-cors and others?, CORP should only be active for no-cors), ...)
  // Relationship with COEP?
  // ...
  const test_declarations = [simple_subresource_loading, object_subresource_loading, sandboxed_subresource_loading, nested_subresource_loading];
  const path = '/_hp/server/responses.py?feature_group=corp&resp_id=';
  const label = 'CORP';
  run_tests(test_declarations, path, label);

</script>
</html>